<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統優化測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        button.warning {
            background: #ffc107;
            color: #212529;
        }
        button.warning:hover {
            background: #e0a800;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .test-steps {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .test-steps ol {
            margin: 0;
            padding-left: 20px;
        }
        .test-steps li {
            margin: 5px 0;
        }
        .data-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .optimization-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .optimization-section {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .optimization-section h4 {
            margin-top: 0;
            color: #495057;
        }
        .performance-metrics {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        .metric-label {
            font-weight: bold;
        }
        .metric-value {
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>系統優化測試</h1>
        
        <div class="test-steps">
            <h3>優化內容：</h3>
            <ol>
                <li>修復重複的存儲適配器初始化</li>
                <li>修復重複的 IndexedDB 初始化</li>
                <li>修復重複的數據遷移</li>
                <li>修復被動事件監聽器警告</li>
                <li>優化性能指標</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>1. 存儲適配器優化測試</h3>
            <div class="data-display" id="storageAdapterStatus">尚未檢查</div>
            <button id="testStorageAdapterBtn">測試存儲適配器</button>
            <button id="testMultipleInitBtn" class="warning">測試多次初始化</button>
            <div id="storageAdapterResult" class="status info" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>2. IndexedDB 優化測試</h3>
            <div class="data-display" id="indexedDBStatus">尚未檢查</div>
            <button id="testIndexedDBBtn">測試 IndexedDB</button>
            <button id="testDataMigrationBtn" class="warning">測試數據遷移</button>
            <div id="indexedDBResult" class="status info" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>3. 事件監聽器優化測試</h3>
            <div class="data-display" id="eventListenersStatus">尚未檢查</div>
            <button id="testEventListenersBtn">測試事件監聽器</button>
            <button id="testPassiveListenersBtn" class="success">測試被動監聽器</button>
            <div id="eventListenersResult" class="status info" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>4. 性能指標</h3>
            <div class="performance-metrics">
                <div class="metric">
                    <span class="metric-label">初始化時間:</span>
                    <span class="metric-value" id="initTime">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">存儲操作時間:</span>
                    <span class="metric-value" id="storageTime">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">事件監聽器數量:</span>
                    <span class="metric-value" id="listenerCount">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">內存使用:</span>
                    <span class="metric-value" id="memoryUsage">-</span>
                </div>
            </div>
            <button id="measurePerformanceBtn" class="success">測量性能</button>
            <div id="performanceResult" class="status info" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>5. 優化前後對比</h3>
            <div class="optimization-info">
                <div class="optimization-section">
                    <h4>優化前</h4>
                    <div class="data-display" id="beforeOptimization">
                        ❌ 重複初始化存儲適配器<br>
                        ❌ 重複初始化 IndexedDB<br>
                        ❌ 重複數據遷移<br>
                        ❌ 被動事件監聽器警告<br>
                        ❌ 性能問題
                    </div>
                </div>
                <div class="optimization-section">
                    <h4>優化後</h4>
                    <div class="data-display" id="afterOptimization">
                        ✅ 單次初始化存儲適配器<br>
                        ✅ 單次初始化 IndexedDB<br>
                        ✅ 智能數據遷移<br>
                        ✅ 正確的被動事件監聽器<br>
                        ✅ 優化的性能
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>6. 操作日誌</h3>
            <div id="log" class="log"></div>
            <button id="clearLogBtn">清除日誌</button>
        </div>
    </div>

    <!-- 載入必要的腳本 -->
    <script src="js/indexeddb-manager.js"></script>
    <script src="js/storage-adapter.js"></script>
    
    <script>
        // 日誌函數
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        // 顯示狀態
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // 測試存儲適配器
        document.getElementById('testStorageAdapterBtn').addEventListener('click', async () => {
            try {
                log('開始測試存儲適配器...');
                showStatus('storageAdapterResult', '正在測試存儲適配器...', 'info');

                const startTime = performance.now();
                
                // 測試初始化
                await window.storageAdapter.init();
                
                const initTime = performance.now() - startTime;
                
                // 檢查狀態
                const status = {
                    initialized: window.storageAdapter.initialized,
                    useIndexedDB: window.storageAdapter.useIndexedDB,
                    storageType: window.storageAdapter.getStorageType(),
                    initTime: `${initTime.toFixed(2)}ms`
                };
                
                document.getElementById('storageAdapterStatus').textContent = 
                    `初始化狀態: ${status.initialized}\n` +
                    `使用 IndexedDB: ${status.useIndexedDB}\n` +
                    `存儲類型: ${status.storageType}\n` +
                    `初始化時間: ${status.initTime}`;
                
                showStatus('storageAdapterResult', '存儲適配器測試完成', 'success');
                log(`存儲適配器測試完成: ${JSON.stringify(status)}`);

            } catch (error) {
                showStatus('storageAdapterResult', `測試失敗: ${error.message}`, 'error');
                log(`存儲適配器測試失敗: ${error.message}`);
            }
        });

        // 測試多次初始化
        document.getElementById('testMultipleInitBtn').addEventListener('click', async () => {
            try {
                log('開始測試多次初始化...');
                showStatus('storageAdapterResult', '正在測試多次初始化...', 'info');

                const initTimes = [];
                
                // 多次初始化測試
                for (let i = 0; i < 5; i++) {
                    const startTime = performance.now();
                    await window.storageAdapter.init();
                    const initTime = performance.now() - startTime;
                    initTimes.push(initTime);
                    log(`第 ${i + 1} 次初始化時間: ${initTime.toFixed(2)}ms`);
                }
                
                const avgTime = initTimes.reduce((a, b) => a + b, 0) / initTimes.length;
                const maxTime = Math.max(...initTimes);
                const minTime = Math.min(...initTimes);
                
                const result = `平均時間: ${avgTime.toFixed(2)}ms, 最大: ${maxTime.toFixed(2)}ms, 最小: ${minTime.toFixed(2)}ms`;
                
                showStatus('storageAdapterResult', result, 'success');
                log(`多次初始化測試完成: ${result}`);

            } catch (error) {
                showStatus('storageAdapterResult', `測試失敗: ${error.message}`, 'error');
                log(`多次初始化測試失敗: ${error.message}`);
            }
        });

        // 測試 IndexedDB
        document.getElementById('testIndexedDBBtn').addEventListener('click', async () => {
            try {
                log('開始測試 IndexedDB...');
                showStatus('indexedDBResult', '正在測試 IndexedDB...', 'info');

                const startTime = performance.now();
                
                // 測試 IndexedDB 初始化
                await window.indexedDBManager.init();
                
                const initTime = performance.now() - startTime;
                
                // 檢查狀態
                const status = {
                    initialized: window.indexedDBManager.isInitialized,
                    dbName: window.indexedDBManager.dbName,
                    dbVersion: window.indexedDBManager.dbVersion,
                    initTime: `${initTime.toFixed(2)}ms`
                };
                
                document.getElementById('indexedDBStatus').textContent = 
                    `初始化狀態: ${status.initialized}\n` +
                    `數據庫名稱: ${status.dbName}\n` +
                    `數據庫版本: ${status.dbVersion}\n` +
                    `初始化時間: ${status.initTime}`;
                
                showStatus('indexedDBResult', 'IndexedDB 測試完成', 'success');
                log(`IndexedDB 測試完成: ${JSON.stringify(status)}`);

            } catch (error) {
                showStatus('indexedDBResult', `測試失敗: ${error.message}`, 'error');
                log(`IndexedDB 測試失敗: ${error.message}`);
            }
        });

        // 測試數據遷移
        document.getElementById('testDataMigrationBtn').addEventListener('click', async () => {
            try {
                log('開始測試數據遷移...');
                showStatus('indexedDBResult', '正在測試數據遷移...', 'info');

                // 添加一些測試數據到 localStorage
                const testData = {
                    testKey1: 'testValue1',
                    testKey2: 'testValue2',
                    testKey3: { nested: 'data' }
                };
                
                Object.entries(testData).forEach(([key, value]) => {
                    localStorage.setItem(key, JSON.stringify(value));
                });
                
                log('添加測試數據到 localStorage');
                
                // 測試遷移
                const startTime = performance.now();
                await window.indexedDBManager.migrateFromLocalStorage();
                const migrationTime = performance.now() - startTime;
                
                // 清理測試數據
                Object.keys(testData).forEach(key => {
                    localStorage.removeItem(key);
                });
                
                showStatus('indexedDBResult', `數據遷移測試完成，耗時: ${migrationTime.toFixed(2)}ms`, 'success');
                log(`數據遷移測試完成，耗時: ${migrationTime.toFixed(2)}ms`);

            } catch (error) {
                showStatus('indexedDBResult', `測試失敗: ${error.message}`, 'error');
                log(`數據遷移測試失敗: ${error.message}`);
            }
        });

        // 測試事件監聽器
        document.getElementById('testEventListenersBtn').addEventListener('click', () => {
            try {
                log('開始測試事件監聽器...');
                showStatus('eventListenersResult', '正在測試事件監聽器...', 'info');

                // 創建測試元素
                const testElement = document.createElement('div');
                testElement.style.width = '100px';
                testElement.style.height = '100px';
                testElement.style.backgroundColor = '#007bff';
                testElement.style.margin = '10px';
                document.body.appendChild(testElement);

                // 測試不同類型的事件監聽器
                const listeners = [
                    { event: 'click', passive: false },
                    { event: 'touchstart', passive: false },
                    { event: 'touchmove', passive: false },
                    { event: 'touchend', passive: true },
                    { event: 'scroll', passive: true }
                ];

                listeners.forEach(({ event, passive }) => {
                    testElement.addEventListener(event, () => {
                        log(`${event} 事件觸發`);
                    }, { passive });
                });

                const listenerCount = listeners.length;
                
                document.getElementById('eventListenersStatus').textContent = 
                    `事件監聽器數量: ${listenerCount}\n` +
                    `被動監聽器: ${listeners.filter(l => l.passive).length}\n` +
                    `非被動監聽器: ${listeners.filter(l => !l.passive).length}`;
                
                showStatus('eventListenersResult', `事件監聽器測試完成，共 ${listenerCount} 個`, 'success');
                log(`事件監聽器測試完成，共 ${listenerCount} 個`);

                // 清理測試元素
                setTimeout(() => {
                    document.body.removeChild(testElement);
                }, 3000);

            } catch (error) {
                showStatus('eventListenersResult', `測試失敗: ${error.message}`, 'error');
                log(`事件監聽器測試失敗: ${error.message}`);
            }
        });

        // 測試被動監聽器
        document.getElementById('testPassiveListenersBtn').addEventListener('click', () => {
            try {
                log('開始測試被動監聽器...');
                showStatus('eventListenersResult', '正在測試被動監聽器...', 'info');

                // 創建測試元素
                const testElement = document.createElement('div');
                testElement.style.width = '200px';
                testElement.style.height = '200px';
                testElement.style.backgroundColor = '#28a745';
                testElement.style.margin = '10px';
                testElement.style.overflow = 'auto';
                testElement.innerHTML = '<div style="height: 400px; background: linear-gradient(to bottom, #ff0000, #00ff00, #0000ff);"></div>';
                document.body.appendChild(testElement);

                let passiveWarningCount = 0;
                let nonPassiveCount = 0;

                // 測試被動監聽器（不應該有警告）
                testElement.addEventListener('scroll', () => {
                    log('被動 scroll 事件觸發');
                }, { passive: true });

                // 測試非被動監聽器（可能會有警告）
                testElement.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    log('非被動 touchstart 事件觸發');
                    nonPassiveCount++;
                }, { passive: false });

                // 模擬滾動
                setTimeout(() => {
                    testElement.scrollTop = 100;
                }, 100);

                setTimeout(() => {
                    const result = `被動監聽器測試完成，非被動監聽器: ${nonPassiveCount}`;
                    showStatus('eventListenersResult', result, 'success');
                    log(result);
                    
                    // 清理測試元素
                    document.body.removeChild(testElement);
                }, 1000);

            } catch (error) {
                showStatus('eventListenersResult', `測試失敗: ${error.message}`, 'error');
                log(`被動監聽器測試失敗: ${error.message}`);
            }
        });

        // 測量性能
        document.getElementById('measurePerformanceBtn').addEventListener('click', async () => {
            try {
                log('開始測量性能...');
                showStatus('performanceResult', '正在測量性能...', 'info');

                const metrics = {};

                // 測量初始化時間
                const initStartTime = performance.now();
                await window.storageAdapter.init();
                metrics.initTime = performance.now() - initStartTime;

                // 測量存儲操作時間
                const storageStartTime = performance.now();
                await window.storageAdapter.setItem('performanceTest', { test: 'data', timestamp: Date.now() });
                const testData = await window.storageAdapter.getItem('performanceTest');
                await window.storageAdapter.removeItem('performanceTest');
                metrics.storageTime = performance.now() - storageStartTime;

                // 測量事件監聽器數量
                const allElements = document.querySelectorAll('*');
                let listenerCount = 0;
                allElements.forEach(element => {
                    // 這是一個簡化的估算，實際的監聽器數量可能不同
                    listenerCount += element.onclick ? 1 : 0;
                    listenerCount += element.ontouchstart ? 1 : 0;
                    listenerCount += element.ontouchmove ? 1 : 0;
                    listenerCount += element.ontouchend ? 1 : 0;
                });
                metrics.listenerCount = listenerCount;

                // 測量內存使用（如果可用）
                if (performance.memory) {
                    metrics.memoryUsage = `${(performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`;
                } else {
                    metrics.memoryUsage = '不可用';
                }

                // 更新顯示
                document.getElementById('initTime').textContent = `${metrics.initTime.toFixed(2)}ms`;
                document.getElementById('storageTime').textContent = `${metrics.storageTime.toFixed(2)}ms`;
                document.getElementById('listenerCount').textContent = metrics.listenerCount;
                document.getElementById('memoryUsage').textContent = metrics.memoryUsage;

                showStatus('performanceResult', '性能測量完成', 'success');
                log(`性能測量完成: ${JSON.stringify(metrics)}`);

            } catch (error) {
                showStatus('performanceResult', `測量失敗: ${error.message}`, 'error');
                log(`性能測量失敗: ${error.message}`);
            }
        });

        // 清除日誌
        document.getElementById('clearLogBtn').addEventListener('click', () => {
            document.getElementById('log').innerHTML = '';
        });

        // 頁面載入完成
        document.addEventListener('DOMContentLoaded', async () => {
            log('頁面載入完成，系統優化測試準備就緒');
            log('請開始測試各項優化功能');
            
            // 初始化存儲適配器
            try {
                await window.storageAdapter.init();
                log('存儲適配器初始化成功');
            } catch (error) {
                log(`存儲適配器初始化失敗: ${error.message}`);
            }
        });
    </script>
</body>
</html>
