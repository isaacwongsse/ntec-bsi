<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡ä¸Šå‚³æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            padding: 10px 20px;
            margin: 10px 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.secondary {
            background: #2196F3;
        }
        .test-button.danger {
            background: #f44336;
        }
        .log-area {
            margin: 10px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
        }
        .log-success {
            color: #4CAF50;
        }
        .log-error {
            color: #f44336;
        }
        .log-warning {
            color: #ff9800;
        }
        .log-info {
            color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>ğŸ“¸ ç…§ç‰‡ä¸Šå‚³èˆ‡å„²å­˜æ¸¬è©¦å·¥å…·</h1>
    
    <div class="test-section">
        <h2>ç¬¬ä¸€æ­¥ï¼šæ¸…é™¤èˆŠæ•¸æ“šï¼ˆå¯é¸ï¼‰</h2>
        <button class="test-button danger" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•¸æ“š</button>
        <p>å¦‚æœä¹‹å‰æ¸¬è©¦å¤±æ•—ï¼Œå»ºè­°å…ˆæ¸…é™¤èˆŠæ•¸æ“š</p>
    </div>

    <div class="test-section">
        <h2>ç¬¬äºŒæ­¥ï¼šæª¢æŸ¥ç•¶å‰ç‹€æ…‹</h2>
        <button class="test-button secondary" onclick="checkCurrentState()">æª¢æŸ¥ç•¶å‰ç‹€æ…‹</button>
        <div id="state-log" class="log-area"></div>
    </div>

    <div class="test-section">
        <h2>ç¬¬ä¸‰æ­¥ï¼šè¿”å›ä¸»é é¢ä¸Šå‚³ç…§ç‰‡</h2>
        <p>
            <strong>æ“ä½œæ­¥é©Ÿï¼š</strong><br>
            1. é»æ“Šä¸‹é¢çš„æŒ‰éˆ•è¿”å›ä¸»é é¢<br>
            2. é»æ“Š "Select Photo Folder" æˆ–ä½¿ç”¨ "Add photos"<br>
            3. é¸æ“‡åŒ…å«ç…§ç‰‡çš„è³‡æ–™å¤¾<br>
            4. <strong>ç­‰å¾…æ‰€æœ‰ç…§ç‰‡é¡¯ç¤º</strong><br>
            5. <strong>æŸ¥çœ‹æ§åˆ¶å°</strong>ï¼Œç¢ºèªçœ‹åˆ°ä»¥ä¸‹è¨Šæ¯ï¼š
        </p>
        <div class="log-area">
            <div class="log-entry log-success">ğŸ’¾ Saving photos after folder selection...</div>
            <div class="log-entry log-success">ğŸ“Š Photos with dataURL: 16 / 16</div>
            <div class="log-entry log-success">ğŸ’¾ saveDataToStorage: Creating photoMetadata from allPhotos</div>
            <div class="log-entry log-success">ğŸ“Š allPhotos status: {length: 16, ...}</div>
            <div class="log-entry log-success">ğŸ“¸ Saving photo1.jpg with dataURL length: 350000</div>
            <div class="log-entry log-success">âœ… Photos saved to IndexedDB</div>
        </div>
        <button class="test-button" onclick="goToMainPage()">å‰å¾€ä¸»é é¢</button>
    </div>

    <div class="test-section">
        <h2>ç¬¬å››æ­¥ï¼šå†æ¬¡æª¢æŸ¥ç‹€æ…‹</h2>
        <p>ä¸Šå‚³ç…§ç‰‡å¾Œï¼Œè¿”å›é€™å€‹é é¢ï¼Œå†æ¬¡æª¢æŸ¥ç‹€æ…‹</p>
        <button class="test-button secondary" onclick="checkCurrentState()">é‡æ–°æª¢æŸ¥ç‹€æ…‹</button>
    </div>

    <div class="test-section">
        <h2>ç¬¬äº”æ­¥ï¼šæ¸¬è©¦é é¢é‡è¼‰</h2>
        <p>å¦‚æœç…§ç‰‡å·²æ­£ç¢ºä¿å­˜ï¼Œæ¸¬è©¦é é¢é‡è¼‰æ˜¯å¦èƒ½æ¢å¾©</p>
        <button class="test-button" onclick="testPageReload()">æ¸¬è©¦é é¢é‡è¼‰</button>
    </div>

    <script>
        function log(message, type = 'info') {
            const logArea = document.getElementById('state-log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function clearAllData() {
            const logArea = document.getElementById('state-log');
            logArea.innerHTML = '';
            
            try {
                log('ğŸ—‘ï¸ é–‹å§‹æ¸…é™¤æ•¸æ“š...', 'info');
                
                // æ¸…é™¤ IndexedDB
                const dbName = 'PlanPNE_Database';
                const deleteRequest = indexedDB.deleteDatabase(dbName);
                
                await new Promise((resolve, reject) => {
                    deleteRequest.onsuccess = resolve;
                    deleteRequest.onerror = reject;
                });
                
                log('âœ… IndexedDB å·²æ¸…é™¤', 'success');
                
                // æ¸…é™¤ localStorage
                localStorage.clear();
                log('âœ… localStorage å·²æ¸…é™¤', 'success');
                
                log('ğŸ‰ æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤ï¼è«‹é‡æ–°ä¸Šå‚³ç…§ç‰‡', 'success');
            } catch (error) {
                log('âŒ æ¸…é™¤æ•¸æ“šå¤±æ•—: ' + error.message, 'error');
            }
        }

        async function checkCurrentState() {
            const logArea = document.getElementById('state-log');
            logArea.innerHTML = '';
            
            log('ğŸ” æª¢æŸ¥ç•¶å‰ç‹€æ…‹...', 'info');
            log('', 'info');
            
            try {
                // æª¢æŸ¥ IndexedDB
                const dbName = 'PlanPNE_Database';
                const request = indexedDB.open(dbName, 1);
                
                request.onsuccess = async (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('mainData')) {
                        log('âš ï¸ IndexedDB ä¸å­˜åœ¨æˆ–ç‚ºç©º', 'warning');
                        log('ğŸ“ å»ºè­°ï¼šå…ˆä¸Šå‚³ç…§ç‰‡', 'info');
                        return;
                    }
                    
                    const transaction = db.transaction(['mainData'], 'readonly');
                    const store = transaction.objectStore('mainData');
                    const getRequest = store.get('photoNumberExtractorData');
                    
                    getRequest.onsuccess = () => {
                        const data = getRequest.result?.data;
                        
                        if (!data) {
                            log('âš ï¸ IndexedDB ä¸­æ²’æœ‰æ•¸æ“š', 'warning');
                            log('ğŸ“ å»ºè­°ï¼šå…ˆä¸Šå‚³ç…§ç‰‡', 'info');
                            return;
                        }
                        
                        log('âœ… IndexedDB æ•¸æ“šå­˜åœ¨', 'success');
                        log('', 'info');
                        
                        // æª¢æŸ¥ç…§ç‰‡æ•¸æ“š
                        const photoMetadata = data.photoMetadata || [];
                        log(`ğŸ“¸ photoMetadata é•·åº¦: ${photoMetadata.length}`, photoMetadata.length > 0 ? 'success' : 'error');
                        
                        if (photoMetadata.length === 0) {
                            log('âŒ ç…§ç‰‡æ•¸æ“šç‚ºç©ºï¼', 'error');
                            log('ğŸ“ åŸå› ï¼šä¸Šå‚³ç…§ç‰‡æ™‚ allPhotos å…¨å±€è®Šé‡æ˜¯ç©ºçš„', 'warning');
                            log('ğŸ“ è§£æ±ºæ–¹æ¡ˆï¼š', 'info');
                            log('   1. é»æ“Šä¸‹æ–¹ "æ¸…é™¤æ‰€æœ‰æ•¸æ“š" æŒ‰éˆ•', 'info');
                            log('   2. å‰å¾€ä¸»é é¢', 'info');
                            log('   3. é¸æ“‡ç…§ç‰‡è³‡æ–™å¤¾', 'info');
                            log('   4. ç­‰å¾…æ‰€æœ‰ç…§ç‰‡é¡¯ç¤º', 'info');
                            log('   5. ç¢ºèªæ§åˆ¶å°é¡¯ç¤º "âœ… Photos saved to IndexedDB"', 'info');
                        } else {
                            log(`âœ… æ‰¾åˆ° ${photoMetadata.length} å¼µç…§ç‰‡`, 'success');
                            log('', 'info');
                            
                            // æª¢æŸ¥ dataURL
                            const photosWithDataURL = photoMetadata.filter(p => p.dataURL && p.dataURL.trim() !== '');
                            log(`ğŸ“Š æœ‰ dataURL çš„ç…§ç‰‡: ${photosWithDataURL.length} / ${photoMetadata.length}`, 
                                photosWithDataURL.length === photoMetadata.length ? 'success' : 'warning');
                            
                            if (photosWithDataURL.length < photoMetadata.length) {
                                log('âš ï¸ éƒ¨åˆ†ç…§ç‰‡æ²’æœ‰ dataURL', 'warning');
                            }
                            
                            // é¡¯ç¤ºå‰3å¼µç…§ç‰‡çš„è³‡è¨Š
                            log('', 'info');
                            log('ğŸ“‹ å‰3å¼µç…§ç‰‡è©³æƒ…:', 'info');
                            photoMetadata.slice(0, 3).forEach((photo, i) => {
                                log(`   ${i + 1}. ${photo.name}`, 'info');
                                log(`      - å¤§å°: ${(photo.size / 1024).toFixed(2)} KB`, 'info');
                                log(`      - é¡å‹: ${photo.type}`, 'info');
                                log(`      - dataURL: ${photo.dataURL ? `${(photo.dataURL.length / 1024).toFixed(2)} KB` : 'ç„¡'}`, 
                                    photo.dataURL ? 'success' : 'error');
                            });
                            
                            log('', 'info');
                            log('ğŸ‰ ç…§ç‰‡æ•¸æ“šæ­£å¸¸ï¼å¯ä»¥æ¸¬è©¦é é¢é‡è¼‰', 'success');
                        }
                        
                        // æª¢æŸ¥å…¶ä»–æ•¸æ“š
                        log('', 'info');
                        log('ğŸ“Š å…¶ä»–æ•¸æ“šçµ±è¨ˆ:', 'info');
                        log(`   - æª¢æŸ¥è¨˜éŒ„: ${data.inspectionRecords?.length || 0}`, 'info');
                        log(`   - æ¨“å±¤å¹³é¢åœ–æ¨™ç±¤: ${data.floorPlanLabels?.length || 0}`, 'info');
                        log(`   - ç¼ºé™·æ¨™è¨˜: ${data.floorPlanDefectMarks?.length || 0}`, 'info');
                    };
                    
                    getRequest.onerror = () => {
                        log('âŒ è®€å– IndexedDB å¤±æ•—', 'error');
                    };
                };
                
                request.onerror = () => {
                    log('âŒ æ‰“é–‹ IndexedDB å¤±æ•—', 'error');
                };
            } catch (error) {
                log('âŒ æª¢æŸ¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        function goToMainPage() {
            window.location.href = './index.html';
        }

        function testPageReload() {
            if (confirm('é€™å°‡é‡æ–°è¼‰å…¥ä¸»é é¢ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                window.location.href = './index.html';
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥
        window.addEventListener('load', () => {
            setTimeout(checkCurrentState, 500);
        });
    </script>
</body>
</html>

